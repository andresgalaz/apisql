DELIMITER //
DROP PROCEDURE IF EXISTS prBorraUsuario //
CREATE PROCEDURE prBorraUsuario (in prm_pUsuario integer )
BEGIN
    DELETE FROM tUsuarioVehiculo
    WHERE  pUsuario = prm_pUsuario;
    DELETE FROM tAuditoria
    WHERE  fVehiculo IN ( SELECT v.pVehiculo
                          FROM   tVehiculo v
                          WHERE  v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tEvento
    WHERE  fUsuario = prm_pUsuario
    OR     fVehiculo IN ( SELECT v.pVehiculo
                          FROM   tVehiculo v
                          WHERE  v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tInicioTransferencia
    WHERE  fVehiculo in ( SELECT v.pVehiculo
                          FROM tVehiculo v
                          WHERE  v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tSiniestroArchivo 
    WHERE  fSiniestro IN ( SELECT s.pSiniestro
                           FROM   tSiniestro s
                                  INNER JOIN tVehiculo v ON s.fVehiculo=v.pVehiculo
                           WHERE  s.fUsuario = prm_pUsuario
                           OR     v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tSiniestroDano
    WHERE  pSiniestro IN ( SELECT s.pSiniestro
                           FROM   tSiniestro s
                                  INNER JOIN tVehiculo v ON s.fVehiculo=v.pVehiculo
                           WHERE  s.fUsuario = prm_pUsuario
                           OR     v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tSiniestroPersona
    WHERE  pSiniestro IN ( SELECT s.pSiniestro
                           FROM   tSiniestro s
                                  inner join tVehiculo v ON s.fVehiculo=v.pVehiculo
                           WHERE  s.fUsuario = prm_pUsuario
                           OR     v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tSiniestroSub
    WHERE  pSiniestro in ( SELECT s.pSiniestro
                           FROM   tSiniestro s
                                  INNER JOIN tVehiculo v ON s.fVehiculo=v.pVehiculo
                           WHERE  s.fUsuario = prm_pUsuario
                           OR     v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tSiniestroSubDano
    WHERE  pSiniestro IN ( SELECT s.pSiniestro
                           FROM   tSiniestro s
                                  INNER JOIN tVehiculo v ON s.fVehiculo=v.pVehiculo
                           WHERE  s.fUsuario = prm_pUsuario
                           OR     v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tSiniestro
    WHERE  fUsuario = prm_pUsuario
    OR     fVehiculo IN ( SELECT v.pVehiculo
                          FROM   tVehiculo v
                          WHERE  v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tVehiculoDesconectado
    WHERE  pVehiculo IN ( SELECT v.pVehiculo
                          FROM   tVehiculo v
                          WHERE  v.fUsuarioTitular = prm_pUsuario );
    DELETE FROM tVehiculo
    WHERE  fUsuarioTitular = prm_pUsuario;
    DELETE FROM tCuenta
    WHERE  fUsuarioTitular = prm_pUsuario;
    DELETE FROM tAppEstado
    WHERE  fUsuario = prm_pUsuario;
    DELETE FROM tUsuario
    WHERE  pUsuario = prm_pUsuario;
END //

DELIMITER ;
